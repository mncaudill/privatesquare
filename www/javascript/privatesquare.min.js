var checking_in=false,searching=false;function privatesquare_init(){navigator.geolocation.getCurrentPosition(_privatesquare_geolocation_onsuccess,_privatesquare_geolocation_onerror);$("#checkin").submit(privatesquare_submit);$("#again").click(privatesquare_reset);$("#status").html("Asking the sky where you are...")}function privatesquare_reset(){$("#venues").hide();$("#status").html();_privatesquare_hide_map();privatesquare_init()}
function privatesquare_submit(){if(checking_in)return false;var a=$("#where").val(),b=$("#what").val(),c=$("#broadcast").val();c=b==2?"":c;if(a==-1){privatesquare_search();return false}checking_in=true;a={method:"privatesquare.venues.checkin",crumb:$("#where").attr("data-crumb"),venue_id:a,status_id:b,broadcast:c};$.ajax({url:_cfg.abs_root_url+"api/",type:"POST",data:a,success:_privatesquare_checkin_onsuccess});$("#venues").hide();_privatesquare_hide_map();$("#status").html("Checking in...");return false}
function _privatesquare_geolocation_onsuccess(a){privatesquare_fetch_venues(a.coords.latitude,a.coords.longitude)}
function privatesquare_search(){if(searching)return false;searching=true;_privatesquare_hide_map();$("#venues").hide();var a=prompt("Search for a particular place");if(!a){$("#status").html('Okay, I\'m giving up. <a href="#" onclick="privatesquare_init();return false;">Start over</a> if you want change your mind.');return false}navigator.geolocation.getCurrentPosition(function(b){privatesquare_fetch_venues(b.coords.latitude,b.coords.longitude,a);searching=false},function(){});$("#status").html("Re-checking your location first...");
return false}function privatesquare_fetch_venues(a,b,c){a={method:"foursquare.venues.search",latitude:a,longitude:b};if(c!="")a.query=c;$.ajax({url:_cfg.abs_root_url+"api/",data:a,success:_foursquare_venues_onsuccess});$("#status").html("Fetching nearby places...")}function _privatesquare_geolocation_onerror(){$("#status").html("Huh. I have no idea where you are...")}
function _foursquare_venues_onsuccess(a){checking_in=false;$("#status").html("");if(a.stat!="ok")_privatesquare_api_error(a);else{var b=a.venues.length;if(b){for(var c="",e=0;e<b;e++){var d=a.venues[e];c+='<option value="'+d.id+'">'+d.name+"</option>"}c+='<option value="-1">\u2013\u2013 none of the above / search \u2013\u2013</option>';b=$("#where");b.attr("data-crumb",a.crumb);b.html(c);b.change(_privatesquare_where_onchange);$("#what").change(_privatesquare_what_onchange);_privatesquare_show_map(a.latitude,
a.longitude);$("#status").html("");$("#venues").show()}else{c="You appear to have fallen in to a black hole. There's nothing around here";if(a.query)c+=" that looks like <q>"+htmlspecialchars(a.query)+"</q>";c+='. <a href="#" onclick="privatesquare_search();return false;">Try again</a>';c+=' or <a href="#" onclick="privatesquare_init();return false;">start from scratch</a>?';$("#status").html(c)}}}
function _privatesquare_where_onchange(){$("#where").val()==-1&&privatesquare_search();return false}function _privatesquare_what_onchange(){var a=$("#what").val(),b=$("#broadcast");a==2?b.attr("disabled","disabled"):b.removeAttr("disabled")}function _privatesquare_checkin_onsuccess(a){$("#status").html("");if(a.stat!="ok")_privatesquare_api_error(a);else{a="Success!";a+=' <a href="#" onclick="privatesquare_init();return false;">Do it again?</a>';$("#status").html(a)}}
function _privatesquare_api_error(a){var b="Oh noes. There was a problem completing your request. ";if(a=a.error){b+="The robot monkeys report: ";b+=a.error+" (error code #"+a.code+"). "}else b+="It appears to be a privatesquare problem rather than foursquare weirdness. ";b+='<a href="#" onclick="privatesquare_init();return false;">Try it again?</a>';$("#status").html(b)}
function _privatesquare_show_map(a,b){var c=a+","+b,e=$("#map-wrapper"),d=document.createElement("div");d=$(d);d.attr("class","map");d.attr("data-zoom",14);d.attr("data-center",c);d.attr("data-hash",false);d.attr("data-touch",true);d.attr("data-provider","toner");var f=document.createElement("div");f=$(f);f.attr("class","marker");f.attr("data-location",c);f.html("you are here-ish");d.html(f);e.html(d);e.show();d.htmapl()}
function _privatesquare_hide_map(){var a=$("#map-wrapper"),b=$(".map");a.hide();b.remove()};
