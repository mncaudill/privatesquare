var checking_in=false,searching=false;function privatesquare_init(){privatesquare_whereami(_privatesquare_geolocation_onsuccess,_privatesquare_geolocation_onerror);$("#checkin").submit(privatesquare_submit);$("#again").click(privatesquare_reset);privatesquare_set_status("Asking the sky where you are...")}
function _privatesquare_geolocation_onsuccess(a){var b=a.coords.latitude;a=a.coords.longitude;!window.navigator.onLine&&_cfg.deferred_checkins?privatesquare_deferred_checkin(b,a,"offline"):privatesquare_fetch_venues(b,a)}function _privatesquare_geolocation_onerror(){privatesquare_set_status("Huh. I have no idea where you are...")}function privatesquare_reset(){$("#venues").hide();privatesquare_unset_status();_privatesquare_hide_map();privatesquare_init()}
function privatesquare_submit(){var a=privatesquare_gather_args();if(a.venue_id==-1){privatesquare_search();return false}privatesquare_checkin(a,privatesquare_checkin_onsuccess);$("#venues").hide();_privatesquare_hide_map();privatesquare_set_status("Checking in...");return false}function privatesquare_gather_args(){var a=$("#where").val(),b=$("#what").val(),c=$("#broadcast").val();c=b==2?"":c;return{crumb:$("#where").attr("data-crumb"),venue_id:a,status_id:b,broadcast:c}}
function privatesquare_checkin(a,b){if(checking_in)return false;b||(b=privatesquare_checkin_onsuccess);checking_in=true;a.method="privatesquare.venues.checkin";$.ajax({url:_cfg.abs_root_url+"api/",type:"POST",data:a,error:function(){checking_in=false},success:function(c){checking_in=false;b(c)}})}
function privatesquare_search(){if(searching)return false;searching=true;_privatesquare_hide_map();$("#venues").hide();var a=prompt("Search for a particular place");if(!a){privatesquare_set_status('Okay, I\'m giving up. <a href="#" onclick="privatesquare_init();return false;">Start over</a> if you want change your mind.');return false}privatesquare_whereami(function(b){privatesquare_fetch_venues(b.coords.latitude,b.coords.longitude,a);searching=false},function(){});privatesquare_set_status("Re-checking your location first...");
return false}function privatesquare_fetch_venues(a,b,c){a={method:"foursquare.venues.search",latitude:a,longitude:b};if(c!="")a.query=c;$.ajax({url:_cfg.abs_root_url+"api/",data:a,success:_foursquare_venues_onsuccess});privatesquare_set_status("Fetching nearby places...")}
function _foursquare_venues_onsuccess(a){privatesquare_unset_status();if(a.stat!="ok")privatesquare_whereami(function(f){privatesquare_deferred_checkin(f.coords.latitude,f.coords.longitude,"api error")},function(){privatesquare_api_error(a)});else{var b=a.venues.length;if(b){for(var c="",d=0;d<b;d++){var e=a.venues[d];c+='<option value="'+e.id+'">'+e.name+"</option>"}c+='<option value="-1">\u2013\u2013 none of the above / search \u2013\u2013</option>';b=$("#where");b.attr("data-crumb",a.crumb);b.html(c);
b.change(_privatesquare_where_onchange);$("#what").change(_privatesquare_what_onchange);_privatesquare_show_map(a.latitude,a.longitude);privatesquare_unset_status();$("#venues").show();$("#checkin").submit(privatesquare_submit)}else{c="You appear to have fallen in to a black hole. There's nothing around here";if(a.query)c+=" that looks like <q>"+htmlspecialchars(a.query)+"</q>";c+='. <a href="#" onclick="privatesquare_search();return false;">Try again</a>';c+=' or <a href="#" onclick="privatesquare_init();return false;">start from scratch</a>?';
privatesquare_set_status(c)}}}function _privatesquare_where_onchange(){$("#where").val()==-1&&privatesquare_search();return false}function _privatesquare_what_onchange(){var a=$("#what").val(),b=$("#broadcast");a==2?b.attr("disabled","disabled"):b.removeAttr("disabled")}function privatesquare_checkin_onsuccess(a,b){$("#status").html("");b||(b=privatesquare_init);if(a.stat!="ok")privatesquare_api_error(a,b);else location.href=_cfg.abs_root_url+"venue/"+a.checkin.venue_id+"?success=1"}
function privatesquare_api_error(a,b){var c="Oh noes. There was a problem completing your request. ",d=a.error;if(d){c+="The robot monkeys report: ";c+=d.error+" (error code #"+d.code+"). "}else c+="It appears to be a privatesquare problem rather than foursquare weirdness. ";if(b){c+='<button id="tryagain">Try it again?</button>';c+="&#160;&#160;";c+='<button id="donot_tryagain">Forget it</button>'}privatesquare_set_status(c);if(b){$("#tryagain").click(b);$("#donot_tryagain").click(function(){$("#status").html("");
$("#status").hide()})}}function _privatesquare_show_map(a,b,c){c||(c="you are here-ish");a=a+","+b;b=$("#map-wrapper");var d=document.createElement("div");d=$(d);d.attr("class","map");d.attr("data-zoom",14);d.attr("data-center",a);d.attr("data-hash",false);d.attr("data-touch",true);d.attr("data-provider","toner");var e=document.createElement("div");e=$(e);e.attr("class","marker");e.attr("data-location",a);e.html(htmlspecialchars(c));d.html(e);b.html(d);b.show();privatesquare_htmapl(d)}
function privatesquare_htmapl(a){a||(a=$(".map"));try{a.htmapl()}catch(b){a.html('<div class="map-error">hrmph...failed to load map: '+b+"</div>")}}function _privatesquare_hide_map(){var a=$("#map-wrapper"),b=$(".map");a.hide();b.remove()}function privatesquare_set_status(a){$("#status").html(a);$("#status").show()}function privatesquare_unset_status(){$("#status").html("");$("#status").hide()}
function privatesquare_whereami(a,b){try{navigator.geolocation.getCurrentPosition(a,b,{enableHighAccuracy:true,maximumAge:1E3})}catch(c){alert("The sky is angry offering only this, today: "+c)}};
